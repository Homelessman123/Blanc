// Prisma Schema for MongoDB
// This schema is designed for MongoDB deployment on Railway

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id              String          @id @default(auto()) @map("_id") @db.ObjectId
  email           String          @unique
  name            String?
  password        String
  avatar          String?
  role            Role            @default(USER)
  balance         Float           @default(0)
  
  // Personalization fields
  displayName     String?
  profileColor    String?         @default("#6366f1")
  profileGif      String?
  phoneNumber     String?
  location        String?
  streak          Int             @default(0)
  lastLoginDate   DateTime?
  
  // Notification preferences
  emailNotifications    Boolean   @default(true)
  pushNotifications     Boolean   @default(true)
  contestReminders      Boolean   @default(true)
  
  // Teammate Matching Fields
  seekingRoles    String[]        @default([])
  skillTagIds     String[]        @db.ObjectId
  interestTagIds  String[]        @db.ObjectId
  futureMajor     String?

  // Relations - using embedded arrays for MongoDB
  streakLogs      StreakLog[]
  calendarEvents  CalendarEvent[]
  contests        Contest[]
  products        Product[]
  orders          Order[]
  transactions    Transaction[]
  payoutRequests  PayoutRequest[]
  contestParticipations ContestParticipation[]
  productReviews  ProductReview[]
  teamRecruitmentsOwned TeamRecruitment[]
  teamRecruitmentMemberships TeamRecruitmentMember[]
  passwordResetToken PasswordResetToken?
  adminAuditLogs  AdminAuditLog[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model Order {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  userId        String        @db.ObjectId
  user          User          @relation(fields: [userId], references: [id])
  items         OrderItem[]
  totalPrice    Float
  status        OrderStatus   @default(PENDING)
  transactions  Transaction[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model OrderItem {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  quantity    Int
  name        String
  price       Float

  orderId     String    @db.ObjectId
  order       Order     @relation(fields: [orderId], references: [id])

  productId   String    @db.ObjectId
  product     Product   @relation(fields: [productId], references: [id])
}

model Transaction {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  amount      Float
  type        TransactionType

  userId      String          @db.ObjectId
  user        User            @relation(fields: [userId], references: [id])

  orderId     String?         @db.ObjectId
  order       Order?          @relation(fields: [orderId], references: [id])

  createdAt   DateTime        @default(now())
}

model PayoutRequest {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  amount      Float
  status      PayoutStatus  @default(PENDING)

  userId      String        @db.ObjectId
  user        User          @relation(fields: [userId], references: [id])

  createdAt   DateTime      @default(now())
  processedAt DateTime?     
}

model Contest {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  startDate   DateTime
  endDate     DateTime
  registrationDeadline DateTime?
  organizer   String
  website     String?
  imageUrl    String?
  category    String?
  tags        String[]  @default([])
  maxParticipants Int?
  currentParticipants Int @default(0)
  prize       String?
  requirements String?
  isActive    Boolean  @default(true)
  
  // Contest details
  fee         Float?   @default(0)
  format      ContestFormat @default(ONLINE)
  targetGrade String?
  registrationUrl String?
  
  // Detailed information (embedded documents)
  benefits    String[]  @default([])
  eligibility String[]  @default([])
  schedule    Json?
  judges      Json?
  partners    Json?
  contactInfo Json?
  
  authorId    String   @db.ObjectId
  author      User     @relation(fields: [authorId], references: [id])

  suggestedProductIds String[] @db.ObjectId
  participants        ContestParticipation[]
  calendarEvents      CalendarEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model StreakLog {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id])
  email       String?
  date        DateTime
  streakCount Int
  action      String
  timestamp   DateTime @default(now())
}

model CalendarEvent {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  userId           String    @db.ObjectId
  user             User      @relation(fields: [userId], references: [id])
  contestId        String?   @db.ObjectId
  contest          Contest?  @relation(fields: [contestId], references: [id])
  title            String
  description      String?
  startDate        DateTime
  endDate          DateTime
  type             String    @default("CONTEST")
  notificationSent Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model Product {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String
  price       Float
  type        ProductType
  imageUrl    String?
  downloadUrl String?
  isApproved  Boolean     @default(false)
  categories  String[]    @default([])
  rating      Float?      @default(0)
  reviewCount Int         @default(0)
  
  // Course specific fields
  duration    String?
  level       CourseLevel? @default(BEGINNER)
  language    String?     @default("Vietnamese")
  
  sellerId    String      @db.ObjectId
  seller      User        @relation(fields: [sellerId], references: [id])

  orderItems  OrderItem[]
  reviews     ProductReview[]

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model ContestParticipation {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id])
  contestId   String   @db.ObjectId
  contest     Contest  @relation(fields: [contestId], references: [id])
  
  // Registration details
  fullName    String
  email       String
  phone       String
  school      String
  grade       String
  birthDate   DateTime
  parentPhone String?
  reason      String?
  
  status      RegistrationStatus @default(PENDING)
  joinedAt    DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, contestId])
}

model ProductReview {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  rating      Int
  comment     String?
  
  productId   String   @db.ObjectId
  product     Product  @relation(fields: [productId], references: [id])
  
  reviewerId  String?  @db.ObjectId
  reviewer    User?    @relation(fields: [reviewerId], references: [id])
  reviewerName String?
  reviewerEmail String?
  isVerifiedPurchase Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([productId, reviewerId])
}

model TeamRecruitment {
  id               String                 @id @default(auto()) @map("_id") @db.ObjectId
  title            String
  teamName         String?
  summary          String
  description      String
  lookingFor       String?
  requirements     String?
  location         String?
  status           TeamRecruitmentStatus  @default(OPEN)
  maxMembers       Int                    @default(4)
  
  ownerId          String                 @db.ObjectId
  owner            User                   @relation(fields: [ownerId], references: [id])
  
  tags             String[]               @default([])
  members          TeamRecruitmentMember[]
  
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
}

model TeamRecruitmentMember {
  id         String              @id @default(auto()) @map("_id") @db.ObjectId
  teamId     String              @db.ObjectId
  team       TeamRecruitment     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId     String              @db.ObjectId
  user       User                @relation(fields: [userId], references: [id])
  role       String?
  status     TeamMemberStatus    @default(ACTIVE)
  joinedAt   DateTime            @default(now())

  @@unique([teamId, userId])
}

model AdminAuditLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  actorId    String   @db.ObjectId
  actor      User     @relation(fields: [actorId], references: [id])
  action     String
  targetType String
  targetId   String?
  metadata   Json?
  createdAt  DateTime @default(now())
}

model PasswordResetToken {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  userId           String   @unique @db.ObjectId
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  otpHash          String?
  otpExpiresAt     DateTime?
  resetTokenHash   String?
  resetExpiresAt   DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model SkillTag {
  id    String   @id @default(auto()) @map("_id") @db.ObjectId
  name  String   @unique
}

model InterestTag {
  id    String   @id @default(auto()) @map("_id") @db.ObjectId
  name  String   @unique
}

// Enums
enum Role {
  USER
  ADMIN
}

enum ProductType {
  COURSE
  DOCUMENT
  WORKSHOP
  CONSULTATION
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum ContestFormat {
  ONLINE
  OFFLINE
  HYBRID
}

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum TransactionType {
  SALE
  PAYOUT
  REFUND
  DEPOSIT
}

enum PayoutStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSING
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum TeamRecruitmentStatus {
  OPEN
  FULL
  CLOSED
}

enum TeamMemberStatus {
  ACTIVE
  LEFT
  REMOVED
}
