generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id              String          @id @default(cuid())
  email           String          @unique
  name            String?
  password        String
  avatar          String?
  role            Role            @default(USER)
  balance         Float           @default(0)
  
  // Personalization fields
  displayName     String?
  profileColor    String?         @default("#6366f1")
  profileGif      String?
  phoneNumber     String?
  location        String?         // Địa điểm người dùng ở
  streak          Int             @default(0)
  lastLoginDate   DateTime?
  streakLogs      StreakLog[]
  calendarEvents  CalendarEvent[]
  
  // Notification preferences
  emailNotifications    Boolean   @default(true)
  pushNotifications     Boolean   @default(true)
  contestReminders      Boolean   @default(true)
  
  // New Teammate Matching Fields
  seekingRoles    String[]      @default([]) @db.Json // Roles the user is looking for, e.g., ["Backend Developer", "UI/UX Designer"]
  skillTags       SkillTag[]
  interestTags    InterestTag[]
  futureMajor     String?       // Ngành học dự định (optional)

  contests        Contest[]
  products        Product[]
  orders          Order[]
  transactions    Transaction[]
  payoutRequests  PayoutRequest[]
  contestParticipations ContestParticipation[]
  productReviews ProductReview[]
  teamRecruitmentsOwned TeamRecruitment[] @relation("OwnedTeamRecruitments")
  teamRecruitmentMemberships TeamRecruitmentMember[]
  passwordResetToken PasswordResetToken?
  adminAuditLogs   AdminAuditLog[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model Order {
  id            String        @id @default(cuid())
  user          User          @relation(fields: [userId], references: [id])
  userId        String
  items         OrderItem[]
  totalPrice    Float
  status        OrderStatus   @default(PENDING)
  transactions  Transaction[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model OrderItem {
  id          String    @id @default(cuid())
  quantity    Int
  name        String    // Snapshot of product name
  price       Float     // Snapshot of product price

  order       Order     @relation(fields: [orderId], references: [id])
  orderId     String

  product     Product   @relation(fields: [productId], references: [id])
  productId   String
}

model Transaction {
  id          String          @id @default(cuid())
  amount      Float
  type        TransactionType

  user        User            @relation(fields: [userId], references: [id])
  userId      String

  order       Order?          @relation(fields: [orderId], references: [id])
  orderId     String?

  createdAt   DateTime        @default(now())
}

model PayoutRequest {
  id          String        @id @default(cuid())
  amount      Float
  status      PayoutStatus  @default(PENDING)

  user        User          @relation(fields: [userId], references: [id])
  userId      String

  createdAt   DateTime      @default(now())
  processedAt DateTime?     
}

model Contest {
  id          String   @id @default(cuid())
  title       String
  description String   @db.Text
  startDate   DateTime
  endDate     DateTime
  registrationDeadline DateTime?
  organizer   String
  website     String?
  imageUrl    String?
  category    String?
  tags        String?  @db.Text // JSON string of tags
  maxParticipants Int?
  currentParticipants Int @default(0)
  prize       String?
  requirements String?  @db.Text
  isActive    Boolean  @default(true)
  
  // New fields
  fee         Float?   @default(0) // Contest fee (0 means free)
  format      ContestFormat @default(ONLINE) // Online or Offline
  targetGrade String?  // Target grade level (e.g., "THCS", "THPT", "6-9", "10-12")
  registrationUrl String? // URL for registration
  
  // Detailed information fields (similar to Course structure)
  benefits    Json?    // Array of benefits (e.g., ["Giải thưởng cao", "Chứng chỉ quốc tế"])
  eligibility Json?    // Array of eligibility requirements (e.g., ["Học sinh THPT", "Dưới 18 tuổi"])
  schedule    Json?    // Array of schedule items with date and activity
  judges      Json?    // Array of judge information (name, title, avatar, bio)
  partners    Json?    // Array of partners/sponsors (name, logo, website)
  contactInfo Json?    // Object with email, phone, address
  
  author      User     @relation(fields: [authorId], references: [id])
  authorId    String

  suggestedProducts Product[] @relation("ContestProducts")
  participants      ContestParticipation[]
  calendarEvents    CalendarEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([registrationDeadline])
  @@index([startDate])
  @@index([category])
}

model StreakLog {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  email       String?
  date        DateTime
  streakCount Int
  action      String
  timestamp   DateTime @default(now())

  @@index([userId, date])
}

model CalendarEvent {
  id               String    @id @default(cuid())
  user             User      @relation(fields: [userId], references: [id])
  userId           String
  contest          Contest?  @relation(fields: [contestId], references: [id])
  contestId        String?
  title            String
  description      String?
  startDate        DateTime
  endDate          DateTime
  type             String    @default("CONTEST")
  notificationSent Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([userId])
  @@index([contestId])
}

model Product {
  id          String      @id @default(cuid())
  name        String
  description String      @db.Text
  price       Float
  type        ProductType
  imageUrl    String?
  downloadUrl String?     // For digital products
  isApproved  Boolean     @default(false)
  categories  String?     @db.Text // JSON string of categories
  rating      Float?      @default(0)
  reviewCount Int         @default(0)
  
  // Course specific fields
  duration    String?     // Duration in weeks/months (e.g., "8 weeks", "3 months")
  level       CourseLevel? @default(BEGINNER)
  language    String?     @default("Vietnamese")
  
  seller      User        @relation(fields: [sellerId], references: [id])
  sellerId    String

  contests    Contest[]   @relation("ContestProducts")
  orderItems  OrderItem[]
  reviews     ProductReview[]

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

// New models for additional features

model ContestParticipation {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  contest     Contest  @relation(fields: [contestId], references: [id])
  contestId   String
  
  // Registration details
  fullName    String
  email       String
  phone       String
  school      String
  grade       String
  birthDate   DateTime
  parentPhone String?
  reason      String?  @db.Text
  
  // Registration metadata
  status      RegistrationStatus @default(PENDING)
  joinedAt    DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, contestId])
  @@index([contestId])
  @@index([email])
}

model ProductReview {
  id          String   @id @default(cuid())
  rating      Int      // 1-5 stars
  comment     String?  @db.Text
  
  product     Product  @relation(fields: [productId], references: [id])
  productId   String
  
  // Enhanced reviewer info
  reviewer    User?    @relation(fields: [reviewerId], references: [id])
  reviewerId  String?
  reviewerName String?
  reviewerEmail String?
  isVerifiedPurchase Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
    @@unique([productId, reviewerId]) // One review per user per product
}

enum Role {
  USER
  ADMIN
}

enum ProductType {
  COURSE
  DOCUMENT
  WORKSHOP
  CONSULTATION
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum ContestFormat {
  ONLINE
  OFFLINE
  HYBRID
}

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum TransactionType {
  SALE
  PAYOUT
  REFUND
  DEPOSIT
}

enum PayoutStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSING
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model TeamRecruitment {
  id               String                 @id @default(cuid())
  title            String
  teamName         String?
  summary          String
  description      String                 @db.Text
  lookingFor       String?                @db.Text
  requirements     String?                @db.Text
  location         String?
  status           TeamRecruitmentStatus  @default(OPEN)
  maxMembers       Int                    @default(4)
  owner            User                   @relation("OwnedTeamRecruitments", fields: [ownerId], references: [id])
  ownerId          String
  tags             TeamRecruitmentTag[]
  members          TeamRecruitmentMember[]
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  @@index([status])
  @@index([ownerId])
}

model TeamRecruitmentMember {
  id         String              @id @default(cuid())
  team       TeamRecruitment     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId     String
  user       User                @relation(fields: [userId], references: [id])
  userId     String
  role       String?
  status     TeamMemberStatus    @default(ACTIVE)
  joinedAt   DateTime            @default(now())

  @@unique([teamId, userId])
  @@index([userId])
  @@index([status])
}

model TeamTag {
  id        String               @id @default(cuid())
  name      String               @unique
  createdAt DateTime             @default(now())
  teams     TeamRecruitmentTag[]
}

model TeamRecruitmentTag {
  team   TeamRecruitment @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId String
  tag    TeamTag         @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId  String

  assignedAt DateTime    @default(now())

  @@id([teamId, tagId])
  @@index([tagId])
}

model AdminAuditLog {
  id         String   @id @default(cuid())
  actor      User     @relation(fields: [actorId], references: [id])
  actorId    String
  action     String
  targetType String
  targetId   String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([targetType, targetId])
}

model PasswordResetToken {
  id               String   @id @default(cuid())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           String   @unique
  otpHash          String?
  otpExpiresAt     DateTime?
  resetTokenHash   String?
  resetExpiresAt   DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([otpExpiresAt])
  @@index([resetExpiresAt])
}

enum TeamRecruitmentStatus {
  OPEN
  FULL
  CLOSED
}

enum TeamMemberStatus {
  ACTIVE
  LEFT
  REMOVED
}

// New models for Teammate Matching v2
model SkillTag {
  id    String @id @default(cuid())
  name  String @unique
  users User[]
}

model InterestTag {
  id    String @id @default(cuid())
  name  String @unique
  users User[]
}